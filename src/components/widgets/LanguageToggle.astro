---
import { SITE_LANGUAGE, t } from "@config";
import { Icon } from "astro-icon/components";

// Generate a unique ID for each component instance
const uniqueId = `language-toggle-${Math.random().toString(36).substring(2, 11)}`;

interface Props {
  className?: string;
}

const { className = "" } = Astro.props as Props;

// æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
const SUPPORTED_LANGUAGES = [
  { code: "en", label: "English", flag: "ğŸ‡ºğŸ‡¸" },
  { code: "zh", label: "ä¸­æ–‡", flag: "ğŸ‡¨ğŸ‡³" },
  { code: "fr", label: "FranÃ§ais", flag: "ğŸ‡«ğŸ‡·" },
  { code: "ja", label: "æ—¥æœ¬èª", flag: "ğŸ‡¯ğŸ‡µ" },
  { code: "ko", label: "í•œêµ­ì–´", flag: "ğŸ‡°ğŸ‡·" },
  { code: "es", label: "EspaÃ±ol", flag: "ğŸ‡ªğŸ‡¸" },
  { code: "de", label: "Deutsch", flag: "ğŸ‡©ğŸ‡ª" },
  { code: "ru", label: "Ğ ÑƒÑÑĞºĞ¸Ğ¹", flag: "ğŸ‡·ğŸ‡º" },
  { code: "pt", label: "PortuguÃªs", flag: "ğŸ‡µğŸ‡¹" },
  { code: "it", label: "Italiano", flag: "ğŸ‡®ğŸ‡¹" },
];

const currentLang = SUPPORTED_LANGUAGES.find((lang) => lang.code === SITE_LANGUAGE) || SUPPORTED_LANGUAGES[0];
---

<div id={uniqueId} class:list={["dropdown dropdown-end", className]}>
  <button
    class="btn btn-circle btn-md bg-base-100 shadow-sm hover:scale-110"
    aria-label="Switch language"
    title="Switch language"
  >
    <span class="text-lg">{currentLang.flag}</span>
  </button>
  <ul class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
    {
      SUPPORTED_LANGUAGES.map((lang) => (
        <li>
          <button
            class:list={["language-option", { active: lang.code === SITE_LANGUAGE }]}
            data-lang={lang.code}
          >
            <span class="text-lg">{lang.flag}</span>
            <span>{lang.label}</span>
            {lang.code === SITE_LANGUAGE && <Icon name="lucide:check" class="w-4 h-4" />}
          </button>
        </li>
      ))
    }
  </ul>
</div>

<script define:vars={{ SUPPORTED_LANGUAGES }}>
  document.addEventListener("astro:page-load", () => {
    const languageOptions = document.querySelectorAll(".language-option");

    languageOptions.forEach((option) => {
      option.addEventListener("click", async (e) => {
        e.preventDefault();
        const selectedLang = option.getAttribute("data-lang");

        // å°†é€‰æ‹©çš„è¯­è¨€ä¿å­˜åˆ° localStorage
        localStorage.setItem("preferred-language", selectedLang);

        // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°è¯­è¨€
        // æ³¨æ„ï¼šè¿™éœ€è¦åœ¨åç«¯æ”¯æŒï¼Œé€šè¿‡ URL å‚æ•°æˆ– cookie æ¥æ”¹å˜è¯­è¨€
        window.location.reload();
      });
    });
  });
</script>

<style>
  .language-option {
    @apply flex items-center justify-between w-full px-4 py-2 rounded hover:bg-base-200 transition-colors;
  }

  .language-option.active {
    @apply bg-primary text-primary-content;
  }
</style>
